# Архитектура системы - Редактор лидарных карт

## Обзор архитектуры

Система построена по модульному принципу с четким разделением ответственности между компонентами.

```
┌─────────────────────────────────────────────────────────────┐
│                    GUI Layer (PyQt6)                        │
│  ┌─────────────────┐  ┌──────────────────┐  ┌─────────────┐ │
│  │   Main Window   │  │  Parameter Panel │  │ Statistics  │ │
│  │                 │  │                  │  │   Panel     │ │
│  └─────────────────┘  └──────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                  Core Processing Layer                       │
│  ┌─────────────────┐  ┌──────────────────┐  ┌─────────────┐ │
│  │ Point Cloud     │  │ Dynamic Object   │  │ Interactive │ │
│  │ Loader          │  │ Detector         │  │ Visualizer  │ │
│  └─────────────────┘  └──────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   Utility Layer                             │
│  ┌─────────────────┐  ┌──────────────────┐  ┌─────────────┐ │
│  │ File I/O        │  │ Geometric        │  │ Clustering  │ │
│  │ Operations      │  │ Analysis         │  │ Algorithms  │ │
│  └─────────────────┘  └──────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                 External Libraries                          │
│     Open3D    │   Scikit-learn   │   NumPy   │   SciPy     │
└─────────────────────────────────────────────────────────────┘
```

## Основные компоненты

### 1. Point Cloud Loader (`point_cloud_loader.py`)

**Назначение**: Загрузка, сохранение и базовая обработка PCD файлов

**Основные методы**:
- `load_pcd()`: загрузка PCD файлов с использованием Open3D
- `save_pcd()`: сохранение точечных облаков
- `get_bounds()`: вычисление границ облака точек
- `remove_points()`: удаление точек по индексам

**Особенности**:
- Поддержка ASCII и бинарных PCD форматов
- Автоматическое определение структуры данных
- Обработка больших файлов (оптимизация памяти)
- Сохранение метаданных (количество точек, границы, etc.)

### 2. Dynamic Object Detector (`dynamic_object_detector.py`)

**Назначение**: Автоматическое обнаружение динамических объектов

**Алгоритм обнаружения**:
```
1. Обнаружение плоскости земли (RANSAC)
   ├── Параметры: distance_threshold=0.1, iterations=1000
   └── Результат: коэффициенты плоскости [a,b,c,d]

2. Фильтрация по высоте
   ├── Вычисление расстояния от точек до плоскости земли
   └── Отбор точек выше порога (по умолчанию 0.2м)

3. Кластеризация (DBSCAN)
   ├── Параметры: eps=0.5, min_samples=10
   └── Группировка близких точек в кластеры

4. Анализ геометрии кластеров
   ├── Вычисление bounding box
   ├── Анализ размеров (высота, ширина, длина)
   ├── Вычисление плотности точек
   └── Проверка соответствия критериям ТС

5. Классификация
   ├── Динамические: соответствуют критериям ТС
   └── Статические: не соответствуют критериям
```

**Критерии классификации транспорта**:
- Высота: 0.5-3.0 м
- Ширина: 1.0-3.0 м
- Длина: 2.0-8.0 м
- Минимальная плотность: < 0.1 точек/м³
- Минимальное количество точек: 20

### 3. Interactive Visualizer (`visualizer.py`)

**Назначение**: 3D визуализация и интерактивное редактирование

**Основные возможности**:
- Интерактивная 3D визуализация с Open3D
- Цветовое кодирование результатов классификации
- Инструменты выделения (box, sphere)
- Операции редактирования (удаление, копирование, вставка)

**Цветовая схема**:
```python
colors = {
    'original': [0.7, 0.7, 0.7],    # Серый - исходные точки
    'selected': [1.0, 0.0, 0.0],    # Красный - выделенные
    'dynamic': [1.0, 0.5, 0.0],     # Оранжевый - динамические
    'static': [0.0, 1.0, 0.0],      # Зеленый - статические
    'ground': [0.5, 0.3, 0.1],      # Коричневый - земля
    'uncertain': [1.0, 1.0, 0.0],   # Желтый - неопределенные
}
```

### 4. Main GUI (`main_gui.py`)

**Назначение**: Главное окно приложения и координация компонентов

**Архитектура GUI**:
```
MainWindow
├── MenuBar (File, Tools, Help)
├── ToolBar (Load, Save, Detect, 3D View)
├── StatusBar (Progress, Messages)
└── Central Widget
    ├── Left Panel (300px)
    │   ├── File Operations
    │   ├── Detection Controls
    │   ├── Visualization Controls
    │   ├── Parameter Panel
    │   └── Statistics Panel
    └── Right Panel (1100px)
        └── Info/Instructions
```

**Многопоточность**:
- Загрузка файлов в отдельном потоке
- Обнаружение объектов в `DetectionWorker` потоке
- 3D визуализация в отдельном потоке
- GUI остается отзывчивым во время обработки

### 5. Utilities (`utils.py`)

**Назначение**: Вспомогательные функции для обработки точечных облаков

**Основные функции**:
- `downsample_point_cloud()`: даунсэмплинг с помощью voxel grid
- `remove_outliers()`: удаление статистических выбросов
- `estimate_normals()`: оценка нормалей к поверхности
- `segment_plane_ransac()`: сегментация плоскости
- `compute_point_density()`: вычисление локальной плотности
- `merge_close_clusters()`: объединение близких кластеров

## Структура данных

### DetectionResult
```python
@dataclass
class DetectionResult:
    dynamic_indices: np.ndarray     # Индексы динамических точек
    static_indices: np.ndarray      # Индексы статических точек
    clusters: List[np.ndarray]      # Список кластеров
    confidence_scores: np.ndarray   # Оценки уверенности
    method_used: str               # Использованный метод
```

### SelectionRegion
```python
@dataclass
class SelectionRegion:
    center: np.ndarray      # Центр области
    size: np.ndarray        # Размеры области
    rotation: np.ndarray    # Матрица поворота
    indices: np.ndarray     # Индексы точек в области
    region_type: str        # Тип области (box, sphere, polygon)
```

## Потоки выполнения

### 1. Загрузка файла
```
User clicks "Load" → QFileDialog → Background thread
    ├── PointCloudLoader.load_pcd()
    ├── Parse PCD header
    ├── Load point data
    ├── Compute metadata
    └── Update GUI (main thread)
```

### 2. Обнаружение объектов
```
User clicks "Detect" → DetectionWorker thread
    ├── DynamicObjectDetector.detect_dynamic_objects()
    ├── Ground plane detection (RANSAC)
    ├── Height filtering
    ├── Clustering (DBSCAN)
    ├── Geometric analysis
    ├── Classification
    └── Update GUI with results (main thread)
```

### 3. 3D визуализация
```
User clicks "3D View" → Separate thread
    ├── InteractiveVisualizer.initialize()
    ├── Setup Open3D window
    ├── Load point cloud
    ├── Apply color coding
    ├── Register callbacks
    └── Run visualization loop
```

## Оптимизации производительности

### 1. Память
- Использование numpy arrays для эффективного хранения
- Копирование данных только при необходимости
- Освобождение памяти после обработки
- Поддержка больших файлов через потоковую обработку

### 2. Вычисления
- Векторизованные операции с NumPy
- Оптимизированные алгоритмы scikit-learn
- Параллельная обработка кластеров
- Кэширование результатов вычислений

### 3. GUI
- Асинхронная загрузка файлов
- Прогресс-бары для длительных операций
- Отзывчивый интерфейс через многопоточность
- Ленивая инициализация компонентов

## Расширяемость

### Добавление новых алгоритмов обнаружения
1. Наследование от `DynamicObjectDetector`
2. Реализация метода `detect_dynamic_objects()`
3. Добавление в GUI выбор алгоритма

### Поддержка новых форматов файлов
1. Расширение `PointCloudLoader`
2. Добавление парсеров для новых форматов
3. Обновление GUI для выбора формата

### Новые инструменты редактирования
1. Расширение `InteractiveVisualizer`
2. Добавление новых типов выделения
3. Реализация новых операций редактирования

## Зависимости

### Основные библиотеки
- **Open3D 0.19.0**: 3D обработка и визуализация
- **NumPy 2.3.3**: численные вычисления
- **Scikit-learn 1.7.2**: машинное обучение
- **PyQt6 6.9.1**: графический интерфейс
- **SciPy 1.16.2**: научные вычисления

### Вспомогательные библиотеки
- **Matplotlib**: построение графиков
- **Pandas**: работа с данными
- **tqdm**: прогресс-бары
- **PyYAML**: конфигурационные файлы

## Тестирование

### Модульные тесты
- `test_components.py`: тестирование основных компонентов
- `simple_test.py`: базовые тесты без Open3D
- Покрытие основных функций и граничных случаев

### Интеграционные тесты
- Тестирование полного пайплайна обработки
- Проверка совместимости компонентов
- Тестирование производительности

### Тестовые данные
- Синтетические точечные облака
- Реальные PCD файлы различных размеров
- Граничные случаи (пустые файлы, некорректные данные)

## Развертывание

### Системные требования
- Ubuntu 20.04+ (основная платформа)
- Python 3.8+
- 8+ ГБ RAM
- OpenGL поддержка

### Установка
```bash
git clone <repository>
cd lidar_editor
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Запуск
```bash
python run_app.py  # GUI приложение
python simple_test.py  # Тесты
```
